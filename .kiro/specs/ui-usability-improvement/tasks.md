# 実装計画

## タスク概要

本実装計画は、リバーシゲームボードのユーザビリティ改善機能の実装タスクを定義します。棋譜表示の視覚的非表示化、メッセージ表示のレイアウトシフト防止、メッセージ表示時間の最適化を段階的に実装します。

## 実装タスク

- [x] 1. 棋譜表示の視覚的非表示化を実装する
  - GameBoardコンポーネント内の棋譜表示要素（data-testid='move-history'）を特定
  - Tailwind CSS の `sr-only` クラスを棋譜要素に適用し、視覚的に非表示化
  - `aria-hidden="true"` 属性を追加し、スクリーンリーダーからも除外
  - DOM内に要素を保持したまま、ユーザの視覚から完全に隠蔽
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2. メッセージ表示領域のレイアウトシフト防止を実装する
  - GameBoardコンポーネント内のパス通知メッセージ表示部分を特定
  - 固定高さ（h-16）のコンテナ要素でメッセージ表示領域をラップ
  - メッセージ要素を常にDOM内にレンダリング（条件付きレンダリングを廃止）
  - メッセージの表示/非表示をopacityプロパティ（opacity-100/opacity-0）で切り替え
  - Tailwind CSSの `transition-opacity duration-200` を適用し、滑らかなフェード効果を実現
  - メッセージが非表示の場合でもコンテナの高さを維持（non-breaking spaceを使用）
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [x] 3. メッセージ表示時間を最適化する
  - useGameErrorHandlerフック内のnotifyPass関数を特定
  - パス通知メッセージの自動消去タイマーを3秒から5秒に変更（3000ms → 5000ms）
  - 既存のタイマーキャンセル機能（新しいメッセージが前のタイマーを上書き）を保持
  - タイマーのクリーンアップロジック（unmount時のclearTimeout）を維持
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 4. 既存機能の保持を検証する

- [x] 4.1 既存コンポーネントの動作確認
  - 棋譜生成ロジック（move-history.ts）が変更されていないことを確認
  - メッセージ通知ロジック（useGameErrorHandler）のエラーハンドリング機能が維持されていることを確認
  - GameBoardコンポーネントのdata-testid属性がすべて保持されていることを確認
  - Tailwind CSSのみが使用され、CSS Modulesやインラインスタイルがないことをコードレビュー
  - _Requirements: 4.1, 4.2, 4.5, 4.6_

- [x] 4.2 既存テストスイートの実行と検証
  - Jestユニットテストを全実行し、すべてのテストが成功することを確認（pnpm test）
  - Playwright E2Eテストを全実行し、すべてのテストが成功することを確認（pnpm test:e2e）
  - テストカバレッジが90%以上を維持していることを確認（pnpm test:coverage）
  - TypeScriptコンパイルエラーがないことを確認（pnpm type-check）
  - _Requirements: 4.3, 4.4_

- [x] 5. 新規ユニットテストを追加する

- [x] 5.1 GameBoardコンポーネントのユニットテスト追加
  - 棋譜要素に `sr-only` クラスが適用されていることを検証するテスト (既存テストで実装済み、Task 1で追加)
  - 棋譜要素に `aria-hidden="true"` 属性が設定されていることを検証するテスト (既存テストで実装済み、Task 1で追加)
  - `data-testid="move-history"` 属性が保持されていることを検証するテスト (既存テストで実装済み、Task 1で追加)
  - メッセージ表示領域に固定高さクラス（h-16）が適用されていることを検証するテスト (新規追加)
  - メッセージ要素が常にDOM内に存在することを検証するテスト (新規追加)
  - パス通知メッセージ表示時に `opacity-100` クラスが適用されることを検証するテスト (新規追加)
  - パス通知メッセージ非表示時に `opacity-0` クラスが適用されることを検証するテスト (新規追加)
  - `transition-opacity` クラスが適用されていることを検証するテスト (新規追加)
  - _Requirements: 4.3_

- [x] 5.2 useGameErrorHandlerフックのユニットテスト追加
  - notifyPass関数が5秒後にpassNotificationをnullにクリアすることを検証するテスト (既存テストで実装済み、Task 3で追加)
  - 新しいnotifyPass呼び出しが前のタイマーをキャンセルすることを検証するテスト (既存テストで実装済み、Task 3で追加)
  - unmount時にタイマーがクリーンアップされることを検証するテスト (既存テストで実装済み、Task 3で追加)
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 6. 統合テストを追加する
  - GameBoardとuseGameErrorHandlerの統合をテスト：パス操作後に5秒間メッセージが表示され、その後自動消去されることを確認
  - メッセージ表示中に新しいパス操作が発生した場合、メッセージが更新されタイマーがリセットされることを確認
  - メッセージ表示/非表示切り替え時にレイアウトシフトが発生しないことをスナップショットテストで検証
  - _Requirements: 2.4, 2.5, 3.2, 3.3_

- [ ] 7. E2Eテストを追加する

- [ ] 7.1 棋譜非表示のE2Eテスト
  - ゲーム開始後、棋譜要素がDOM内に存在することを確認（getByTestId('move-history')）
  - 棋譜要素がビューポート外に配置されていることを確認（isVisible()がfalse）
  - 棋譜テキストが正確に取得できることを確認
  - _Requirements: 1.1, 1.3, 1.4_

- [ ] 7.2 メッセージレイアウトのE2Eテスト
  - パス操作前後でゲームボード要素のbounding boxが変化しないことを確認
  - メッセージ表示中にゲームボードのY座標が固定されていることを確認
  - メッセージ要素が常にDOM内に存在することを確認
  - _Requirements: 2.4, 2.5_

- [ ] 7.3 メッセージ表示時間のE2Eテスト
  - パス操作後、メッセージが5秒間表示されることを確認（4秒後も表示、6秒後は非表示）
  - 複数回のパス操作でタイマーがリセットされることを確認
  - _Requirements: 3.1, 3.2_

- [ ] 7.4 CSSトランジションのE2Eテスト
  - メッセージ表示時に `opacity-100` クラスが適用されることを確認
  - メッセージ非表示時に `opacity-0` クラスが適用されることを確認
  - `transition-opacity` クラスが適用されていることを確認
  - _Requirements: 2.2, 2.3_

- [ ] 8. クロスブラウザ互換性を検証する
  - Playwright E2EテストをDesktop Chrome、Mobile Chrome、Mobile Safariで実行し、すべて成功することを確認
  - CSS視覚的非表示スタイル（sr-only）がモダンブラウザで一貫して動作することを確認
  - opacity/visibilityの切り替えがモダンブラウザで一貫して動作することを確認
  - Tailwind CSSのベンダープレフィックスがpostcss/autoprefixer経由で自動適用されていることを確認
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 9. 手動QAとLIFF Browser検証を実施する
  - ステージング環境にデプロイし、視覚的な棋譜非表示を手動確認
  - メッセージ表示/非表示時にレイアウトシフトがないことを手動確認
  - メッセージ表示時に滑らかなフェードイン効果があることを手動確認
  - メッセージ非表示時に滑らかなフェードアウト効果があることを手動確認
  - メッセージ表示時間が5秒であることをストップウォッチで計測
  - LINE LIFF browser（iOS WKWebView）で実機検証を実施
  - LINE LIFF browser（Android WebView）で実機検証を実施
  - Chrome DevTools LighthouseでCLSスコアを測定し、改善を確認
  - _Requirements: 2.2, 2.3, 2.4, 2.5, 3.1, 5.3_

## 実装順序の理由

1. **タスク1（棋譜非表示化）**: 最も独立した変更であり、他のタスクに影響しない
2. **タスク2（レイアウトシフト防止）**: DOM構造の変更を伴うため、メッセージタイマー変更の前に実施
3. **タスク3（タイマー最適化）**: DOM構造変更後に実施することで、新しい構造での動作を検証
4. **タスク4（既存機能保持）**: コード変更後に既存機能が正常動作することを早期に検証
5. **タスク5-7（テスト追加）**: 新機能の品質保証を段階的に構築
6. **タスク8（クロスブラウザ）**: 自動テストで広範なブラウザ互換性を検証
7. **タスク9（手動QA）**: 最終的なユーザ体験を人間の目で確認

## 推定工数

- タスク1: 1時間
- タスク2: 2時間
- タスク3: 30分
- タスク4: 1時間
- タスク5: 2時間
- タスク6: 1.5時間
- タスク7: 2.5時間
- タスク8: 1時間
- タスク9: 2時間

**合計推定工数**: 約13.5時間

## 要件カバレッジ

- **Requirement 1** (棋譜非表示): タスク1, 7.1
- **Requirement 2** (レイアウトシフト防止): タスク2, 6, 7.2
- **Requirement 3** (メッセージ表示時間): タスク3, 5.2, 6, 7.3
- **Requirement 4** (既存機能保持): タスク4, 5, 6, 7
- **Requirement 5** (クロスブラウザ互換性): タスク8, 9

すべての要件がタスクにマッピングされています。
