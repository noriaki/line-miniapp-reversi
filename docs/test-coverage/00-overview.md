# テストカバレッジ改善プラン - 概要

## 目標

全てのカバレッジ指標を90%以上にする

## カバレッジ指標

- Statements (文)
- Branches (分岐)
- Functions (関数)
- Lines (行)

## 現在の状況

**全体指標（目標: 90%以上）:**

- Statements: 82.74% ❌ (目標まで +7.26%)
- Branches: 75.86% ❌ (目標まで +14.14%)
- Functions: 77.86% ❌ (目標まで +12.14%)
- Lines: 82.6% ❌ (目標まで +7.4%)

## 対応が必要なファイル

### 優先度: 高（カバレッジ0%または50%未満）

1. **src/hooks/useAIPlayer.ts** - 全指標 0% 🚨
2. **src/components/WASMErrorHandler.tsx** - 平均 57.9%
3. **src/lib/ai/wasm-loader.ts** - 平均 52.3%

### 優先度: 中（50%以上70%未満）

4. **src/components/ErrorBoundary.tsx** - 平均 68.1%
5. **src/components/GameBoard.tsx** - 平均 84.5%

### 優先度: 低（70%以上90%未満）

6. **src/lib/game/move-history.ts** - 平均 69.3%
7. **src/lib/ai/index.ts** - Functions 42.85%

詳細な対応方針は各優先度別のドキュメントを参照してください：

- [優先度: 高](./01-priority-high.md)
- [優先度: 中](./02-priority-medium.md)
- [優先度: 低](./03-priority-low.md)

---

## 全体サマリー

### 推定される改善後の指標

すべての対応を完了した場合の推定カバレッジ：

| 指標           | 現在   | 改善目標 | 推定達成値 | 達成見込み  |
| -------------- | ------ | -------- | ---------- | ----------- |
| **Statements** | 82.74% | 90%+     | 95%+       | ✅ 達成可能 |
| **Branches**   | 75.86% | 90%+     | 92%+       | ✅ 達成可能 |
| **Functions**  | 77.86% | 90%+     | 93%+       | ✅ 達成可能 |
| **Lines**      | 82.6%  | 90%+     | 95%+       | ✅ 達成可能 |

**注意**:

- 改善幅は各ファイルの影響を合算したものです
- 実際の改善幅は、ファイル間の依存関係やテストの重複により異なる場合があります
- 100%を超える予測値は数学的に不可能であるため、現実的な推定値に修正しました

### 優先順位別の対応計画

#### フェーズ1: 高優先度（目標カバレッジへの影響大）

1. **src/hooks/useAIPlayer.ts** (0% → 90%+)
   - 影響: 全指標 +7-10%
   - 工数: 2-3時間
   - **最優先**: カバレッジ0%のため

2. **src/components/WASMErrorHandler.tsx** (64.7% → 90%+)
   - 影響: 全指標 +2-3%
   - 工数: 30分-1時間

3. **src/lib/ai/wasm-loader.ts** (63.04% → 90%+)
   - 影響: Branches +4.8%, 他 +2-3%
   - 工数: 1.5-2時間

#### フェーズ2: 中優先度（エッジケース対応）

4. **src/components/ErrorBoundary.tsx** (73.68% → 90%+)
   - 影響: 全指標 +1.6-3%
   - 工数: 30分

5. **src/components/GameBoard.tsx** (81.13% → 90%+)
   - 影響: Statements +1.4%, Functions +1%
   - 工数: 1.5-2時間

#### フェーズ3: 低優先度（細かい改善）

6. **src/lib/game/move-history.ts** (72.72% → 90%+)
   - 影響: Branches +2.8%
   - 工数: 20分

7. **src/lib/ai/index.ts** (42.85% Functions → 90%+)
   - 影響: Functions +3.4%
   - 工数: 15分

### 総工数

- **最小工数**: 約6.5時間
- **最大工数**: 約9時間
- **推奨アプローチ**: フェーズごとに実施し、各フェーズ後にカバレッジを確認

---

## テストパフォーマンスへの影響

### 現在のテストスイート

- **現在の実行時間**: 測定が必要（ベースライン確立）
- **テスト数**: 既存テストケース数を記録

### 予想される影響

新規テストの追加により、テストスイート全体の実行時間が増加する可能性があります：

- **Worker ベースのテスト** (useAIPlayer.ts): モック化により影響を最小限に
- **WASM ローダーテスト** (wasm-loader.ts): 重い操作のモック化が必要
- **統合テスト**: 既存の統合テストとの干渉を避ける

### パフォーマンス維持戦略

1. **重い操作のモック化**
   - WASM モジュールの読み込み
   - Worker の初期化
   - ネットワークリクエスト

2. **テストの並列実行**
   - Jest の `--maxWorkers` オプションを活用
   - 独立したテストケースの同時実行

3. **テストの分離**
   - グローバル状態の漏れを防ぐ
   - 各テスト後のクリーンアップを徹底

4. **実行時間の監視**
   - 各フェーズ後にテストスイート全体の実行時間を計測
   - 閾値を超えた場合は最適化を検討

---

## CI/CD 統合

### カバレッジ閾値の設定

プロジェクトの Jest 設定（`jest.config.js`）にカバレッジ閾値を追加：

```javascript
module.exports = {
  // ... 既存の設定
  coverageThreshold: {
    global: {
      statements: 90,
      branches: 90,
      functions: 90,
      lines: 90,
    },
  },
};
```

### PR のブロック条件

以下の条件を満たさない PR はマージをブロック：

1. **カバレッジ閾値**: 全指標が90%以上
2. **テストの成功**: すべてのテストがパス
3. **ビルドの成功**: TypeScript コンパイルエラーなし

### カバレッジレポートの自動化

1. **CI でのカバレッジ生成**
   - PRごとにカバレッジレポートを生成
   - カバレッジの変化を PR コメントで通知

2. **カバレッジバッジ**
   - README にカバレッジバッジを追加（検討中）

---

## エッジケースのドキュメント方針

### エッジケースの重要性を記録

各エッジケースについて、以下を明確にする：

1. **発生条件**: どのような状況で発生するか
2. **影響範囲**: ユーザー体験やシステムへの影響
3. **テストの価値**: なぜこのケースをテストする必要があるのか

### 例: consecutivePassCount の範囲外

**発生条件**:

- ゲームロジックのバグや状態管理の不整合

**影響範囲**:

- ゲームが予期しない状態になり、プレイ不能になる可能性

**テストの価値**:

- 開発環境で早期に検出し、本番環境でのバグを防ぐ
- 防御的プログラミングの効果を検証

---

## メンテナンス戦略

### 90%以上のカバレッジを維持する方法

1. **新規コード追加時のルール**
   - 新しいコンポーネント/関数には必ずテストを追加
   - PR レビュー時にカバレッジの変化を確認

2. **Pre-commit フック**
   - Husky と lint-staged を活用（既に設定済み）
   - コミット前にテストを自動実行（オプション）

3. **定期的なカバレッジレビュー**
   - 月次でカバレッジレポートを確認
   - カバレッジが低下した箇所を特定し、改善

4. **テストコードのリファクタリング**
   - テストコードも保守対象
   - 重複するテストケースの統合
   - 読みやすさと保守性の向上

### 新規コードのガイドライン

- **必須テストカバレッジ**: 新規コードは90%以上
- **テストファースト**: TDD を推奨
- **レビュー基準**: テストがない PR はマージしない

---

## 品質メトリクス

カバレッジパーセンテージ以外の成功基準：

### 1. テストの信頼性

- ✅ **Flaky テストゼロ**: 不安定なテストは即座に修正
- ✅ **決定論的**: 同じ入力で常に同じ結果

### 2. テストの実行速度

- ✅ **全テスト実行時間**: 5分以内（目標）
- ✅ **単体テストスイート**: 2分以内（目標）

### 3. テストの品質

- ✅ **警告ゼロ**: コンソール警告やエラーなし
- ✅ **適切な Assertion**: 各テストケースに明確な検証

### 4. 非同期処理の適切な処理

- ✅ **Promise の await**: すべての非同期処理を適切に待機
- ✅ **タイムアウトエラーなし**: 非同期処理のタイムアウトを適切に設定

### 5. モックのクリーンアップ

- ✅ **モックのリセット**: 各テスト後にモックを復元
- ✅ **グローバル状態のクリーンアップ**: テスト間の状態漏れを防止

### 6. テストの可読性

- ✅ **明確なテスト名**: テストケースの意図が一目でわかる
- ✅ **AAA パターン**: Arrange-Act-Assert の構造を維持
- ✅ **適切なコメント**: 複雑なテストロジックには説明を追加

---

## 次のステップ

1. [優先度: 高のファイル対応](./01-priority-high.md)を開始
2. [実装アクションプラン](./04-implementation.md)を確認
3. 各フェーズ完了後にこのドキュメントを更新
