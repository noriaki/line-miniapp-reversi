# Implementation Plan

## Tasks

- [ ] 1. シェア画像プレビューコンポーネントの実装
- [ ] 1.1 (P) 画像レンダリング用DOM構造を構築する
  - 8x8盤面グリッドと黒白の石配置を描画するレイアウトを作成
  - スコア表示エリア（黒○個 vs 白○個形式）を配置
  - 勝敗テキスト（「あなたの勝ち！」「AIの勝ち！」「引き分け」）の表示領域を追加
  - アプリロゴまたはタイトルのブランディング要素を配置
  - OGP推奨サイズ（1200x630px比率）でレイアウトを構成
  - html2canvas互換のインラインスタイルを使用
  - 画面上は非表示（visibility: hidden）でレンダリング
  - _Requirements: 4.2, 4.3, 4.4, 4.5_

- [ ] 2. 画像生成・アップロード機能の実装
- [ ] 2.1 html2canvasによる画像生成機能を実装する
  - DOM要素からCanvasを生成する処理を作成
  - Canvasを高解像度（scale: 2）でキャプチャ
  - Canvas を PNG Blob に変換する処理を実装
  - エラーハンドリング（生成失敗時の処理）を追加
  - _Requirements: 4.1_

- [ ] 2.2 Cloudflare R2への画像アップロード機能を実装する
  - Presigned URL取得APIの呼び出し処理を作成
  - 取得したURLへの画像アップロード処理を実装
  - アップロード完了後の公開URL取得処理を追加
  - アップロードエラー時のハンドリングを実装
  - _Requirements: 4.6, 8.2_

- [ ] 3. Flex Message構築機能の実装
- [ ] 3.1 (P) LINE Flex Messageビルダーを実装する
  - Bubble形式のFlex Messageオブジェクト構築処理を作成
  - Hero部にシェア画像URLを設定する処理を実装
  - Body部に勝敗結果テキストと招待文を配置
  - Footer部に「リバーシで遊ぶ」URIアクションボタンを追加
  - altTextに代替テキストを設定
  - @line/liff のFlexMessage型に準拠
  - _Requirements: 2.4, 2.5, 2.6, 2.7_

- [ ] 4. シェアテキスト生成機能の実装
- [ ] 4.1 (P) シェアテキストビルダーを実装する
  - ゲーム結果（勝敗）をテキストに含める処理を作成
  - スコア情報（黒○個 vs 白○個）を含める処理を実装
  - 招待文（「リバーシで対戦しませんか？」等）を追加
  - アプリURL（LIFFエンドポイント）を末尾に付与
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 5. シェアサービス層の実装
- [ ] 5.1 LINEシェア実行機能を実装する
  - shareTargetPicker APIの利用可否チェック処理を作成
  - Flex Messageを用いたshareTargetPicker呼び出しを実装
  - シェア成功・失敗・キャンセルの結果ハンドリングを追加
  - _Requirements: 2.1, 2.4_

- [ ] 5.2 Web Share API実行機能を実装する
  - navigator.canShare() による対応チェック処理を作成
  - navigator.share() に画像ファイルとテキストを渡す処理を実装
  - シェア成功・失敗・キャンセルの結果ハンドリングを追加
  - ログイン状態に依存しない設計を確認
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 6. シェア状態管理フックの実装
- [ ] 6.1 useShareフックを実装する
  - シェア画像の準備状態（isShareReady）を管理
  - シェア処理中フラグ（isSharing）による排他制御を実装
  - Web Share API対応状態（canWebShare）の判定処理を追加
  - シェア画像URL（shareImageUrl）の状態管理を実装
  - _Requirements: 1.5, 3.4_

- [ ] 6.2 LINEシェアフロー制御を実装する
  - ログイン状態の確認処理（liff.isLoggedIn()）を追加
  - 未ログイン時のログイン誘導処理を実装
  - ログイン完了後のシェアフロー継続処理を追加
  - shareTargetPickerの起動処理を統合
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 6.3 シェア操作フィードバック機能を実装する
  - シェア成功時のトースト通知（「シェアしました！」）を表示
  - エラー発生時のエラーメッセージ通知を表示
  - ユーザーキャンセル時は通知なしで元の画面に戻る処理を実装
  - useMessageQueueとの連携を確認
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 7. シェアボタンコンポーネントの実装
- [ ] 7.1 シェアボタンUIを実装する
  - 「LINEでシェア」ボタンをLINEブランドカラー（#06C755）で作成
  - 「その他でシェア」ボタンを作成
  - タップしやすいサイズ（最小44x44px）を確保
  - シェア準備完了前・処理中はdisabled状態に設定
  - _Requirements: 1.2, 1.3, 1.4_

- [ ] 7.2 シェアボタンの表示制御を実装する
  - Web Share API非対応環境で「その他でシェア」ボタンを非表示
  - canWebShareフラグとの連携を実装
  - _Requirements: 1.5_

- [ ] 8. ゲーム終了画面への統合
- [ ] 8.1 GameBoardコンポーネントにシェア機能を統合する
  - ゲーム終了状態（gameStatus.type === 'finished'）での画像生成開始処理を追加
  - シェアボタンを「新しいゲームを開始」ボタンの隣に配置
  - useShareフックとの連携を実装
  - シェアボタンのイベントハンドラを接続
  - _Requirements: 1.1, 1.2, 4.1, 8.1_

- [ ] 8.2 バックグラウンド画像生成・アップロードを実装する
  - ゲーム終了検出時に非同期で画像生成を開始
  - アップロード完了までシェアボタンを準備中状態に維持
  - ユーザー操作を阻害しない非同期処理を確認
  - _Requirements: 8.1, 8.2_

- [ ] 9. クロスプラットフォーム動作確認とテスト
- [ ] 9.1 (P) ユニットテストを作成する
  - FlexMessageBuilder の Flex Message構造生成テストを作成
  - シェアテキストビルダーの勝敗・スコア別テストを作成
  - useShareフックの状態遷移テストを作成
  - _Requirements: 2.4, 5.1, 5.2, 5.3, 5.4_

- [ ] 9.2 (P) 統合テストを作成する
  - html2canvasによる画像生成処理のテストを作成
  - LIFF SDKモックでのshareTargetPicker呼び出しテストを作成
  - Web Share APIモックでのシェア実行テストを作成
  - _Requirements: 2.1, 3.1, 4.1_

- [ ] 9.3\* E2Eテストを作成する
  - ゲーム終了後のシェアボタン表示確認テストを作成
  - Web Share非対応環境での「その他でシェア」ボタン非表示テストを作成
  - LINEアプリ内ブラウザ、外部ブラウザ（Safari、Chrome）での動作を確認
  - iOS、Android端末での動作を確認
  - _Requirements: 1.1, 1.5, 7.1, 7.2, 7.3, 7.4_

## Requirements Coverage

| Requirement | Tasks         |
| ----------- | ------------- |
| 1.1         | 8.1           |
| 1.2         | 7.1, 8.1      |
| 1.3         | 7.1           |
| 1.4         | 7.1           |
| 1.5         | 6.1, 7.2      |
| 2.1         | 5.1, 6.2      |
| 2.2         | 6.2           |
| 2.3         | 6.2           |
| 2.4         | 3.1, 5.1, 9.1 |
| 2.5         | 3.1           |
| 2.6         | 3.1           |
| 2.7         | 3.1           |
| 3.1         | 5.2, 9.2      |
| 3.2         | 5.2           |
| 3.3         | 5.2           |
| 3.4         | 5.2, 6.1      |
| 4.1         | 2.1, 8.1, 9.2 |
| 4.2         | 1.1           |
| 4.3         | 1.1           |
| 4.4         | 1.1           |
| 4.5         | 1.1           |
| 4.6         | 2.2           |
| 5.1         | 4.1, 9.1      |
| 5.2         | 4.1, 9.1      |
| 5.3         | 4.1, 9.1      |
| 5.4         | 4.1, 9.1      |
| 6.1         | 6.3           |
| 6.2         | 6.3           |
| 6.3         | 6.3           |
| 7.1         | 9.3           |
| 7.2         | 9.3           |
| 7.3         | 9.3           |
| 7.4         | 9.3           |
| 8.1         | 8.1, 8.2      |
| 8.2         | 2.2, 8.2      |
