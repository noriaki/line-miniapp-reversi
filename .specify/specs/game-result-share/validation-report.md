# 検証レポート: ゲーム結果シェア機能

**作成日**: 2025-11-29
**ステータス**: 要対応（クリティカルイシュー3件）

---

## 検証サマリー

| 検証種別     | 結果               | 主な発見                                       |
| ------------ | ------------------ | ---------------------------------------------- |
| Gap分析      | 完了               | 既存資産活用可能、新規インフラ構築が最大リスク |
| 設計レビュー | **GO（条件付き）** | 3つのクリティカルイシューあり                  |

---

## 1. Gap分析結果

### 1.1 既存資産の活用状況

| 既存資産       | ファイル                               | シェア機能での活用             |
| -------------- | -------------------------------------- | ------------------------------ |
| LIFF統合       | `useLiff.ts`, `LiffProvider.tsx`       | ログイン状態取得、ログイン処理 |
| メッセージ通知 | `useMessageQueue.ts`, `MessageBox.tsx` | シェア成功/失敗のトースト通知  |
| ゲーム状態     | `useGameState.ts`                      | 盤面、スコア、勝敗情報の取得   |
| ゲーム終了画面 | `GameBoard.tsx` (L488-494)             | シェアボタン統合ポイント       |

### 1.2 新規実装が必要な要素

| 要素                | 種別         | 複雑度   | 備考                            |
| ------------------- | ------------ | -------- | ------------------------------- |
| ShareButtons        | UI Component | 低       | 既存スタイル参照可能            |
| ShareImagePreview   | UI Component | 中       | html2canvas互換DOM構築          |
| useShare            | Hook         | 中       | 状態管理パターン確立済み        |
| FlexMessageBuilder  | Lib (Pure)   | 低〜中   | Flex Message JSON構築           |
| ShareImageGenerator | Lib          | **高**   | html2canvas統合、Blob変換       |
| R2 Upload Service   | Lib + Infra  | **最高** | Presigned URL API、バケット設定 |

### 1.3 技術的制約

1. **静的エクスポート制約**: `output: 'export'` のためサーバーサイド処理不可
2. **LIFF shareTargetPicker制約**: アクションはURIタイプのみ（postback不可）
3. **html2canvas制約**: 外部画像（CORS）は描画不可、visible要素のみ
4. **Web Share API制約**: 一部ブラウザ非対応（`navigator.canShare`で事前チェック必須）

### 1.4 工数見積

| カテゴリ               | 見積               | 根拠                           |
| ---------------------- | ------------------ | ------------------------------ |
| **全体**               | **M〜L (5〜10日)** | 新規インフラ構築を含む複合機能 |
| UI Layer               | S (1-2日)          | 既存スタイル参照可能           |
| Hooks Layer            | S (1-2日)          | パターン確立済み               |
| Lib Layer              | M (2-3日)          | FlexMessage構築、Web Share統合 |
| **Image Upload Infra** | **L (3-5日)**      | **最大リスク要因**             |
| テスト                 | M (2-3日)          | Unit/Integration/E2E           |

---

## 2. 設計レビュー結果

### 2.1 設計の強み

- **要件トレーサビリティ**: 全35要件がコンポーネント・インターフェースにマッピング済み
- **既存パターン準拠**: Hooks + Pure Functionsパターンに従った設計
- **ドキュメント品質**: シーケンス図・アーキテクチャ図が明確

### 2.2 最終評価

**GO（条件付き）** — 設計の全体構造は堅実だが、下記3つのクリティカルイシューへの対応が必要

---

## 3. クリティカルイシュー

### Issue 1: 画像アップロードAPI設計の未確定

| 項目           | 内容                                                      |
| -------------- | --------------------------------------------------------- |
| **問題**       | Presigned URL生成APIの仕様が「別途検討」のまま未定義      |
| **影響**       | 実装フェーズでAPI設計作業が発生、見積もり不確実性が高まる |
| **関連要件**   | 4.6「外部ストレージにアップロードしてURLを取得する」      |
| **エビデンス** | design.md - ShareImageGenerator Implementation Notes      |

#### 選択肢

| 選択肢 | 内容                            | メリット              | デメリット                 |
| ------ | ------------------------------- | --------------------- | -------------------------- |
| **A**  | 設計書内でAPI最小仕様を定義     | 実装見積もりが明確化  | 設計フェーズが延長         |
| **B**  | 画像アップロードをPhase 2に分離 | Phase 1を早期開始可能 | LINEシェアが画像なしになる |

---

### Issue 2: 静的エクスポートとバックエンドサービスの整合性

| 項目           | 内容                                                                                    |
| -------------- | --------------------------------------------------------------------------------------- |
| **問題**       | `output: 'export'` の静的サイト方針だが、Cloudflare Workers導入でバックエンド依存が発生 |
| **影響**       | インフラ運用コスト増加、デプロイフロー複雑化、アーキテクチャ前提の変更                  |
| **関連要件**   | 4.6, 8.2                                                                                |
| **エビデンス** | design.md - Technology Stack (Storage: Cloudflare R2, Storage API: Cloudflare Workers)  |

#### 選択肢

| 選択肢 | 内容                                             | メリット                     | デメリット                            |
| ------ | ------------------------------------------------ | ---------------------------- | ------------------------------------- |
| **A**  | Cloudflare R2/Workers導入を許容                  | 設計変更なしで進行可能       | 新規インフラ構築・運用コスト          |
| **B**  | 代替ストレージ採用（Cloudinary unsigned preset） | クライアントサイドのみで完結 | 外部サービス依存、無料枠制限          |
| **C**  | 代替ストレージ採用（Vercel Blob）                | 既存Vercelインフラ活用       | 追加コスト、API設計は必要             |
| **D**  | Web Share APIのみ先行実装                        | インフラ不要、即時開始可能   | LINEシェアで画像URL必須のため機能制限 |

---

### Issue 3: LINEログイン後のシェア継続

| 項目           | 内容                                                                          |
| -------------- | ----------------------------------------------------------------------------- |
| **問題**       | `liff.login()` はページリダイレクトを伴うため、シェア操作状態がリセットされる |
| **影響**       | ユーザーがログイン後にシェアフローを最初からやり直す必要、UX低下              |
| **関連要件**   | 2.2「非ログイン時のログイン処理」、2.3「ログイン後のシェア継続」              |
| **エビデンス** | design.md - シェアフロー概要シーケンス図                                      |

#### 選択肢

| 選択肢 | 内容                                  | メリット               | デメリット                 |
| ------ | ------------------------------------- | ---------------------- | -------------------------- |
| **A**  | `redirectUri` にクエリパラメータ付与  | シンプル、状態復元可能 | ゲーム結果の復元が別途必要 |
| **B**  | `localStorage` にゲーム結果を一時保存 | 完全な状態復元が可能   | ストレージ管理ロジック追加 |
| **C**  | A + B の組み合わせ                    | 最も堅牢な実装         | 実装コスト増               |

---

## 4. 推奨対応方針

### 優先度: 高

1. **Issue 2（インフラ方針）の決定** — アーキテクチャ全体に影響するため最優先
2. **Issue 1（API仕様）の最小定義** — インフラ方針決定後に対応

### 優先度: 中

3. **Issue 3（ログイン後シェア継続）の設計追加** — 実装フェーズで対応可能

---

## 5. 次のアクション

クリティカルイシューへの対応方針を決定後、以下のいずれかに進む：

| 方針                            | 次のステップ                                                   |
| ------------------------------- | -------------------------------------------------------------- |
| インフラ追加を許容              | 設計書にデプロイ方針追記 → `/kiro:spec-impl game-result-share` |
| 代替ストレージを採用            | 設計書を更新 → タスク再生成 → 実装開始                         |
| 画像アップロードをPhase 2に分離 | Phase 1スコープ明確化 → Web Share API先行実装                  |

---

## 付録: リスク評価マトリクス

| リスク                         | 発生確率 | 影響度 | 緩和策                             |
| ------------------------------ | -------- | ------ | ---------------------------------- |
| Cloudflare R2インフラ構築遅延  | 高       | 高     | 代替ストレージ検討、事前検証       |
| html2canvas互換性問題          | 中       | 中     | インラインスタイル使用、実機テスト |
| LIFF shareTargetPicker動作不良 | 中       | 中     | LINE Developers Console設定確認    |
| Web Share API非対応環境        | 低       | 低     | `navigator.canShare`で事前チェック |
