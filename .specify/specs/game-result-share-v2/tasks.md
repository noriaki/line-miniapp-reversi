# Implementation Plan

## Tasks

- [x] 1. 設定変更: ISR サポートのための Next.js 設定更新
  - `next.config.ts` から `output: 'export'` を削除し、Hybrid Static/ISR アーキテクチャへ移行
  - この変更により `ImageResponse` による動的 OG 画像生成が利用可能になる
  - ビルドが正常に完了することを確認
  - _Requirements: 7.1_

- [x] 2. 手順履歴エンコーダーの実装
- [x] 2.1 (P) WTHOR 形式での手順エンコード/デコード機能を実装
  - Position を WTHOR 形式の 2 桁数字に変換する関数（row+1 を十の位、col+1 を一の位）
  - 手順配列を WTHOR 形式 + Base64URL でエンコードする関数
  - Base64URL 文字列から手順配列を復元するデコード関数
  - エンコード/デコードの完全な可逆性を保証
  - 最大 60 手（約 80 文字）のエンコードをサポート
  - 不正な入力（無効な長さ、不正な文字、範囲外の位置）に対するエラーハンドリング
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 2.2 手順配列から盤面を復元する機能を実装
  - 初期盤面から手順を順番に適用して最終盤面を計算
  - 既存のゲームロジック（applyMove 関数）を再利用
  - パス（手番スキップ）が発生した場合の正しい処理
  - 不正な手（無効な位置への配置）の検出とエラー返却
  - スコア計算と勝者判定のヘルパー関数
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 2.3 (P) 手順エンコーダーの単体テストを実装
  - エンコード/デコードの可逆性テスト
  - 境界値テスト（0手、60手、パス含む手順）
  - 不正入力に対するエラー検出テスト
  - 盤面復元の正確性テスト
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4_

- [x] 3. 結果ページの実装
- [x] 3.1 結果ページの基本構造とメタデータ生成を実装
  - URL パラメータ（side, encodedMoves）から手順をデコードして盤面を復元
  - 最終盤面、スコア、勝敗結果を表示
  - side パラメータに基づくレイアウト切り替え（b: プレイヤー上部/黒、w: プレイヤー下部/白）
  - ISR 設定（generateStaticParams で空配列、dynamicParams: true）
  - OGP メタタグ（og:image, og:title, og:description）の動的生成
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 7.6_

- [x] 3.2 盤面表示コンポーネントを実装
  - 8x8 の盤面を表示（インタラクティブ機能なし）
  - 既存 GameBoard のスタイルを流用
  - Server Component として実装
  - _Requirements: 4.1_

- [x] 3.3 結果ページのエラーハンドリングを実装
  - 不正な side パラメータ（b/w 以外）の検出
  - 不正なエンコード文字列の検出
  - エラーメッセージとゲームページへの導線を表示
  - _Requirements: 4.9_

- [x] 3.4 「もう一度遊ぶ」ボタンを実装
  - ゲームページへの遷移 CTA
  - _Requirements: 4.7, 4.8_

- [x] 4. OG 画像生成の実装
  - Next.js ImageResponse を使用した 1200x630px の PNG 画像生成
  - 手順から盤面を復元して最終盤面のビジュアルを描画
  - スコア、勝敗結果、アプリブランドを含む
  - side 情報は含めない（汎用画像）
  - flexbox レイアウトで構成（grid 非サポート）
  - Noto Sans JP フォントの読み込み
  - 3 秒以内の生成完了を目標
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 5. シェア機能の実装
- [x] 5.1 (P) Flex Message ビルダーを実装
  - LINE Flex Message Bubble 形式のメッセージオブジェクト生成
  - Hero 画像 URL（OG 画像）、スコア表示、CTA ボタンを含む
  - altText に結果サマリーを設定
  - _Requirements: 5.2, 5.3_

- [x] 5.2 (P) シェアサービスを実装
  - LIFF shareTargetPicker API の呼び出し
  - navigator.share API の呼び出し
  - API 利用可能性のチェック関数
  - キャンセル、成功、エラーのハンドリング
  - _Requirements: 5.1, 6.1, 6.2, 6.3_

- [x] 5.3 シェア状態管理フックを実装
  - シェア中フラグの管理
  - 排他制御（同時シェア防止）
  - 成功/エラートーストの表示（既存の useMessageQueue を活用）
  - キャンセル時はトースト表示なし
  - _Requirements: 5.4, 5.5, 5.6, 6.4, 6.5, 6.6_

- [x] 5.4 シェアボタンコンポーネントを実装
  - 「LINE でシェア」ボタン（LINE Green #06C755）
  - 「その他でシェア」ボタン（Web Share API 非対応時は非表示）
  - シェア中はボタン無効化
  - Client Component として実装
  - _Requirements: 4.5, 4.6_

- [x] 6. ゲーム終了時の自動遷移機能を実装
- [x] 6.1 ナビゲーションフォールバックコンポーネントを実装
  - 自動遷移開始から 2 秒経過後に「結果を確認する」ボタンを表示
  - ボタンタップで結果ページへ手動遷移
  - 自動遷移成功時は表示されない
  - _Requirements: 1.1, 1.4_

- [x] 6.2 GameBoard に自動遷移ロジックを追加
  - ゲーム終了時（finished 状態）に自動遷移トリガー
  - moveHistory をチェス記法から Position 配列に変換してエンコード
  - プレイヤーの手番情報（先攻/後攻）を side パラメータに変換
  - 500ms 後に結果ページへ自動遷移開始
  - 2 秒経過でフォールバックボタン表示
  - 既存の結果表示 UI（ゲーム終了後の表示）を削除
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 7. 統合テストと E2E テストの実装
- [x] 7.1 結果ページの統合テストを実装
  - URL パラメータからの盤面復元テスト
  - 正常/異常 URL での表示テスト
  - OG 画像生成のスナップショットテスト
  - _Requirements: 4.1, 4.9, 7.1_

- [x] 7.2 シェア機能の統合テストを実装
  - useShare フックと ShareService の連携テスト
  - LIFF API のモックを使用したシェアフローテスト
  - _Requirements: 5.1, 5.4, 5.5, 5.6, 6.1, 6.4, 6.5, 6.6_

- [x] 7.3 E2E テストを実装
  - 結果ページ直接アクセス時の表示テスト
  - シェアボタンの表示切り替えテスト（Web Share API 可用性）
  - ※ゲーム終了→結果ページ遷移・フォールバックは手動確認
  - _Requirements: 4.1, 4.5, 4.6, 8.1, 8.2, 8.3, 8.4_
