# 実装計画

## タスク一覧

- [ ] 1. 最終手位置の状態管理を実装する
- [ ] 1.1 useGameStateフックに最終手状態を追加する
  - `lastMove: Position | null` 状態をReact.useStateで管理する
  - ゲーム開始時に `lastMove` を `null` で初期化する
  - 既存のuseGameStateフックの型定義にlastMoveフィールドを追加する
  - _Requirements: 5.1, 5.3, 3.1_

- [ ] 1.2 updateBoard関数のシグネチャを拡張する
  - `updateBoard(newBoard: Board, lastMove?: Position)` とオプショナルパラメータを追加する
  - lastMoveパラメータが渡された場合、setLastMove(lastMove)を呼び出す
  - lastMoveが渡されない場合は状態を変更しない（後方互換性を維持）
  - _Requirements: 5.2, 1.1_

- [ ] 1.3 resetGame関数で最終手状態をクリアする
  - resetGame関数内で `setLastMove(null)` を呼び出す
  - ゲームリセット時に全てのハイライト状態がクリアされることを確認する
  - _Requirements: 3.2_

- [ ] 2. GameBoardコンポーネントでハイライト表示を実装する
- [ ] 2.1 useGameStateから最終手位置を取得する
  - GameBoardコンポーネント内で `const { lastMove, ...otherState } = useGameState()` として最終手を取得する
  - lastMoveの型が `Position | null` として正しく推論されることを確認する
  - _Requirements: 5.4_

- [ ] 2.2 (P) 盤面セルのレンダリングロジックを拡張する
  - 各セルのレンダリング時、`position.row === lastMove?.row && position.col === lastMove?.col` の条件で最終手セルを判定する
  - 条件を満たすセルに `data-last-move="true"` 属性を追加する
  - lastMoveが `null` の場合は属性を追加せず通常のセルとして描画する
  - Optional Chaining (`?.`) を使用してnull安全な参照を行う
  - _Requirements: 1.2, 1.3_

- [ ] 2.3 (P) 着手操作時にupdateBoardへ位置を渡す
  - handleCellClick関数内で `updateBoard(newBoard, position)` として着手位置を渡す
  - AIプレーヤーの着手処理（useEffect内）でも `updateBoard(newBoard, aiMove)` として位置を渡す
  - 人間プレーヤーとAIプレーヤーの双方で最終手がハイライトされることを確認する
  - _Requirements: 2.1, 2.2_

- [ ] 3. CSSハイライトスタイルを実装する
- [ ] 3.1 (P) 基本ハイライトスタイルを定義する
  - GameBoard.cssに `.board-cell[data-last-move]` セレクタを追加する
  - 内側グローエフェクト（`inset 0 0 0 3px rgba(255, 69, 0, 0.7)`）を適用する
  - 外側グローエフェクト（`0 0 12px rgba(255, 69, 0, 0.5)`）を適用する
  - CSSトランジション（`transition: box-shadow 0.3s ease-in-out`）を追加する
  - 他のマスと明確に区別できる視覚スタイルであることを確認する
  - _Requirements: 1.4, 2.3, 6.1, 6.3_

- [ ] 3.2 (P) ダークモード対応スタイルを追加する
  - `@media (prefers-color-scheme: dark)` を使用してダークモードスタイルを定義する
  - より明るいオレンジ（`rgba(255, 140, 0, 0.8)`）でコントラストを確保する
  - ライトモード/ダークモード双方で視認可能であることを確認する
  - _Requirements: 4.2_

- [ ] 3.3 (P) レスポンシブデザイン対応を実装する
  - モバイル画面（640px以下）でボーダー幅を2pxに調整する
  - 小型モバイル画面（375px以下）でグローサイズを6pxに調整する
  - タッチスクリーンで判別可能な十分なサイズと色のコントラストを確保する
  - 盤面サイズに応じてハイライトが適切にスケーリングされることを確認する
  - _Requirements: 4.1, 4.3_

- [ ] 4. パフォーマンス最適化を実施する
- [ ] 4.1 不要な再レンダリングを防止する
  - GameBoardコンポーネントまたはセルレンダリング部分にReact.memoを適用する
  - lastMoveが変更されない場合に再レンダリングが発生しないことを確認する
  - React DevTools Profilerで再レンダリング回数を測定する
  - _Requirements: 6.2_

- [ ] 4.2 レンダリングパフォーマンスを検証する
  - ハイライト表示/非表示時のフレームレートが60fps以上を維持することを確認する
  - CSSトランジションがブラウザのハードウェアアクセラレーションを活用していることを確認する
  - React DevTools Profilerで再レンダリング時間を測定する
  - _Requirements: 6.3_

- [ ] 4.3 既存レンダリングロジックとの互換性を確認する
  - 既存の石の配置アニメーション（placeStone）が正常に動作することを確認する
  - 有効手のヒント表示（pulse）との視覚的干渉がないことを確認する
  - ハイライト効果が既存のCSSクラスと競合しないことを確認する
  - _Requirements: 6.4_

- [ ] 5. テストを実装する
- [ ] 5.1 useGameStateフックの単体テストを追加する
  - updateBoard呼び出し時にlastMoveが正しく更新されることをテストする
  - resetGame呼び出し時にlastMoveがnullに初期化されることをテストする
  - lastMoveがnullの場合とPosition型の場合の両方をテストする
  - _Requirements: 5.1, 5.2, 5.3, 3.2_

- [ ] 5.2 GameBoardコンポーネントの統合テストを追加する
  - 人間プレーヤーの着手後にdata-last-move属性が追加されることをテストする
  - AIプレーヤーの着手後にdata-last-move属性が追加されることをテストする
  - 新しい着手時に前回の属性が削除され新しいセルに追加されることをテストする
  - ゲームリセット時に全てのdata-last-move属性が削除されることをテストする
  - ゲーム終了時に最終手の属性が保持されることをテストする
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 3.2, 3.3_

- [ ]\* 5.3 視覚的回帰テストを追加する
  - 人間プレーヤー着手後のハイライト表示をスクリーンショット比較する
  - AIプレーヤー着手後のハイライト表示をスクリーンショット比較する
  - ダークモード/ライトモード両方でハイライトが視認可能であることを確認する
  - モバイル画面サイズ（640px以下、375px以下）でハイライトが適切にスケーリングされることを確認する
  - _Requirements: 1.4, 2.3, 4.1, 4.2, 4.3_

## 要件カバレッジ

| 要件 | カバーするタスク |
| ---- | ---------------- |
| 1.1  | 1.2, 5.2         |
| 1.2  | 2.2, 5.2         |
| 1.3  | 2.2, 5.2         |
| 1.4  | 3.1, 5.3         |
| 2.1  | 2.3, 5.2         |
| 2.2  | 2.3, 5.2         |
| 2.3  | 3.1, 5.3         |
| 3.1  | 1.1              |
| 3.2  | 1.3, 5.1, 5.2    |
| 3.3  | 5.2              |
| 4.1  | 3.3, 5.3         |
| 4.2  | 3.2, 5.3         |
| 4.3  | 3.3, 5.3         |
| 5.1  | 1.1, 5.1         |
| 5.2  | 1.2, 5.1         |
| 5.3  | 1.1, 5.1         |
| 5.4  | 2.1              |
| 6.1  | 3.1              |
| 6.2  | 4.1              |
| 6.3  | 3.1, 4.2         |
| 6.4  | 4.3              |

## タスク実装順序

1. **Phase 1: 状態管理** (タスク 1.1, 1.2, 1.3) - 最終手位置の状態管理基盤を構築
2. **Phase 2: UI統合** (タスク 2.1, 2.2, 2.3) - GameBoardコンポーネントでハイライト表示を実装
3. **Phase 3: CSSスタイル** (タスク 3.1, 3.2, 3.3) - 視覚的ハイライトスタイルとレスポンシブ対応
4. **Phase 4: 最適化** (タスク 4.1, 4.2, 4.3) - パフォーマンス最適化と互換性確認
5. **Phase 5: テスト** (タスク 5.1, 5.2, 5.3) - 単体テスト、統合テスト、E2Eテスト

並列実行可能なタスク（`(P)` マーク）:

- タスク 2.2, 2.3: UI統合の実装作業（状態管理完了後）
- タスク 3.1, 3.2, 3.3: CSSスタイルの実装（互いに独立したメディアクエリ定義）
